{% extends "base.html" %}

{% block content %}

<h3>{{ title }}</h3>

<form method="post">

    {% csrf_token %}

    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
    {% endif %}

    {% for field in form %}

        <div class="mb-3">

            <label class="form-label">
                {{ field.label }}
            </label>

            {{ field }}

            {% if field.errors %}
                <div class="text-danger small">
                    {{ field.errors }}
                </div>
            {% endif %}

        </div>

    {% endfor %}

    <button class="btn btn-primary">
        Save
    </button>

    <a href="{% url 'home' %}"
       class="btn btn-secondary">
       Cancel
    </a>

</form>


<!-- âœ… MOVE SCRIPT HERE -->

<script>
document.addEventListener('DOMContentLoaded', function () {

    const companySelect = document.getElementById('id_company');
    const departmentSelect = document.getElementById('id_department');

    if (!companySelect || !departmentSelect) return;

    function loadDepartments(companyId, selectedId=null) {

        if (!companyId) {
            departmentSelect.innerHTML = '<option value="">---------</option>';
            return;
        }

        fetch(`/api/departments/company/${companyId}/`)
            .then(response => response.json())
            .then(data => {

                departmentSelect.innerHTML = '<option value="">---------</option>';

                data.forEach(dep => {

                    const option = document.createElement('option');

                    option.value = dep.id;
                    option.textContent = dep.name;

                    if (selectedId && dep.id == selectedId) {
                        option.selected = true;
                    }

                    departmentSelect.appendChild(option);

                });

            });
    }

    // On company change
    companySelect.addEventListener('change', function () {
        loadDepartments(this.value);
    });

    // On edit page (auto-load)
    if (companySelect.value) {

        const currentDepartment = departmentSelect.value;

        loadDepartments(companySelect.value, currentDepartment);
    }

});
</script>

{% endblock %}